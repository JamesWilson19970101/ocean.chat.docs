"use strict";(self.webpackChunkoceanchat_devdocs=self.webpackChunkoceanchat_devdocs||[]).push([[3384],{8314:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>I,contentTitle:()=>C,default:()=>q,frontMatter:()=>T,metadata:()=>r,toc:()=>R});const r=JSON.parse('{"id":"devdocs/microservice","title":"Microservice Architecture","description":"The entire platform is divided into four logical layers, comprising 11 core microservices and 1 data processing pipeline, ensuring a clear separation of responsibilities.","source":"@site/docs/devdocs/microservice.md","sourceDirName":"devdocs","slug":"/devdocs/microservice","permalink":"/ocean.chat.docs/docs/devdocs/microservice","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Message Queue","permalink":"/ocean.chat.docs/docs/devdocs/message queue"}}');var i=n(4848),t=n(8453),a=n(6540),o=n(4164),l=n(5627),c=n(6347),d=n(372),h=n(604),u=n(1861),g=n(8749);function p(e){return a.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,a.isValidElement)(e)&&function(e){const{props:s}=e;return!!s&&"object"==typeof s&&"value"in s}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function m(e){const{values:s,children:n}=e;return(0,a.useMemo)((()=>{const e=s??function(e){return p(e).map((({props:{value:e,label:s,attributes:n,default:r}})=>({value:e,label:s,attributes:n,default:r})))}(n);return function(e){const s=(0,u.XI)(e,((e,s)=>e.value===s.value));if(s.length>0)throw new Error(`Docusaurus error: Duplicate values "${s.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[s,n])}function x({value:e,tabValues:s}){return s.some((s=>s.value===e))}function f({queryString:e=!1,groupId:s}){const n=(0,c.W6)(),r=function({queryString:e=!1,groupId:s}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!s)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return s??null}({queryString:e,groupId:s});return[(0,h.aZ)(r),(0,a.useCallback)((e=>{if(!r)return;const s=new URLSearchParams(n.location.search);s.set(r,e),n.replace({...n.location,search:s.toString()})}),[r,n])]}function v(e){const{defaultValue:s,queryString:n=!1,groupId:r}=e,i=m(e),[t,o]=(0,a.useState)((()=>function({defaultValue:e,tabValues:s}){if(0===s.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!x({value:e,tabValues:s}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${s.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=s.find((e=>e.default))??s[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:s,tabValues:i}))),[l,c]=f({queryString:n,groupId:r}),[h,u]=function({groupId:e}){const s=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,r]=(0,g.Dv)(s);return[n,(0,a.useCallback)((e=>{s&&r.set(e)}),[s,r])]}({groupId:r}),p=(()=>{const e=l??h;return x({value:e,tabValues:i})?e:null})();(0,d.A)((()=>{p&&o(p)}),[p]);return{selectedValue:t,selectValue:(0,a.useCallback)((e=>{if(!x({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);o(e),c(e),u(e)}),[c,u,i]),tabValues:i}}var j=n(9136);const y={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function b({className:e,block:s,selectedValue:n,selectValue:r,tabValues:t}){const a=[],{blockElementScrollPositionUntilNextRender:c}=(0,l.a_)(),d=e=>{const s=e.currentTarget,i=a.indexOf(s),o=t[i].value;o!==n&&(c(s),r(o))},h=e=>{let s=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const n=a.indexOf(e.currentTarget)+1;s=a[n]??a[0];break}case"ArrowLeft":{const n=a.indexOf(e.currentTarget)-1;s=a[n]??a[a.length-1];break}}s?.focus()};return(0,i.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":s},e),children:t.map((({value:e,label:s,attributes:r})=>(0,i.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{a.push(e)},onKeyDown:h,onClick:d,...r,className:(0,o.A)("tabs__item",y.tabItem,r?.className,{"tabs__item--active":n===e}),children:s??e},e)))})}function S({lazy:e,children:s,selectedValue:n}){const r=(Array.isArray(s)?s:[s]).filter(Boolean);if(e){const e=r.find((e=>e.props.value===n));return e?(0,a.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,i.jsx)("div",{className:"margin-top--md",children:r.map(((e,s)=>(0,a.cloneElement)(e,{key:s,hidden:e.props.value!==n})))})}function w(e){const s=v(e);return(0,i.jsxs)("div",{className:(0,o.A)("tabs-container",y.tabList),children:[(0,i.jsx)(b,{...s,...e}),(0,i.jsx)(S,{...s,...e})]})}function k(e){const s=(0,j.A)();return(0,i.jsx)(w,{...e,children:p(e.children)},String(s))}const A={tabItem:"tabItem_Ymn6"};function P({children:e,hidden:s,className:n}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,o.A)(A.tabItem,n),hidden:s,children:e})}const T={},C="Microservice Architecture",I={},R=[{value:"IM Architecture Diagram",id:"im-architecture-diagram",level:2},{value:"Layer 1: Gateway and Access Layer",id:"layer-1-gateway-and-access-layer",level:2},{value:"1. <strong>API Gateway Service (oceanchat-api-gateway)</strong> (Stateless)",id:"1-api-gateway-service-oceanchat-api-gateway-stateless",level:3},{value:"2. <strong>Connection Gateway Service (oceanchat-ws-gateway)</strong> (Stateful)",id:"2-connection-gateway-service-oceanchat-ws-gateway-stateful",level:3},{value:"3. <strong>Message Router Service (oceanchat-router)</strong> (Stateless)",id:"3-message-router-service-oceanchat-router-stateless",level:3},{value:"Layer 2: Core Business Logic Layer",id:"layer-2-core-business-logic-layer",level:2},{value:"4. <strong>Auth Service (oceanchat-auth)</strong> (Stateless)",id:"4-auth-service-oceanchat-auth-stateless",level:3},{value:"5. <strong>User &amp; Relationship Service (oceanchat-user)</strong> (Stateless)",id:"5-user--relationship-service-oceanchat-user-stateless",level:3},{value:"6. <strong>Group Service (oceanchat-group)</strong> (Stateless)",id:"6-group-service-oceanchat-group-stateless",level:3},{value:"7. <strong>Message Logic Service (oceanchat-message)</strong> (Stateless)",id:"7-message-logic-service-oceanchat-message-stateless",level:3},{value:"Layer 3: Message Push Pipeline",id:"layer-3-message-push-pipeline",level:2},{value:"8. <strong>Push Orchestrator Service (oceanchat-orchestrator)</strong> (Stateless)",id:"8-push-orchestrator-service-oceanchat-orchestrator-stateless",level:3},{value:"9. <strong>Real-time Pusher Worker (oceanchat-pusher-realtime)</strong> (Stateless)",id:"9-real-time-pusher-worker-oceanchat-pusher-realtime-stateless",level:3},{value:"10. <strong>Offline Pusher Worker (oceanchat-pusher-offline)</strong> (Stateless)",id:"10-offline-pusher-worker-oceanchat-pusher-offline-stateless",level:3},{value:"Layer 4: Foundational Support Services",id:"layer-4-foundational-support-services",level:2},{value:"11. <strong>Presence Service (oceanchat-presence)</strong> (Stateless)",id:"11-presence-service-oceanchat-presence-stateless",level:3},{value:"12. <strong>Query Service (oceanchat-query)</strong> (Stateless)",id:"12-query-service-oceanchat-query-stateless",level:3},{value:"Data Processing Pipeline (MessagePersistence): Message Persistence",id:"data-processing-pipeline-messagepersistence-message-persistence",level:3},{value:"Process Description",id:"process-description",level:2},{value:"Login Phase",id:"login-phase",level:3},{value:"Message Sending Phase",id:"message-sending-phase",level:3}];function M(e){const s={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.header,{children:(0,i.jsx)(s.h1,{id:"microservice-architecture",children:"Microservice Architecture"})}),"\n",(0,i.jsx)(s.admonition,{title:"Architecture Overview",type:"info",children:(0,i.jsx)(s.p,{children:"The entire platform is divided into four logical layers, comprising 11 core microservices and 1 data processing pipeline, ensuring a clear separation of responsibilities."})}),"\n",(0,i.jsx)(s.h2,{id:"im-architecture-diagram",children:"IM Architecture Diagram"}),"\n",(0,i.jsx)(s.p,{children:"// TODO: Diagram"}),"\n",(0,i.jsx)(s.h2,{id:"layer-1-gateway-and-access-layer",children:"Layer 1: Gateway and Access Layer"}),"\n",(0,i.jsx)(s.p,{children:"This layer is the direct entry point for users, focusing on handling massive concurrent connections, and is a critical performance point for the entire system."}),"\n",(0,i.jsxs)(s.h3,{id:"1-api-gateway-service-oceanchat-api-gateway-stateless",children:["1. ",(0,i.jsx)(s.strong,{children:"API Gateway Service (oceanchat-api-gateway)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"desc",label:"Introduction",default:!0,children:(0,i.jsx)(s.p,{children:"This gateway is the sole entry point for external http requests."})}),(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Request Routing"}),": Core functionality. It serves as the sole entry point for all external RESTful API requests. Client HTTP requests for login, registration, retrieving user information, and querying history all arrive here first. Then, requests are forwarded to the appropriate services according to rules. For example, requests starting with ",(0,i.jsx)(s.code,{children:"/auth/*"})," are forwarded to the ",(0,i.jsx)(s.code,{children:"oceanchat-auth"})," service, and ",(0,i.jsx)(s.code,{children:"/users/*"})," are forwarded to the ",(0,i.jsx)(s.code,{children:"oceanchat-user"})," service."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Authentication"}),": Since asynchronous non-blocking I/O is currently being used, this process not only verifies the validity of the JWT but also queries the Redis whitelist to ensure the validity of the user's identity. Interfaces that do not require authentication are allowed directly."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Rate Limiting"}),": For example, limiting the number of requests from the same IP address to 10 per second to protect backend services from overload."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Logs and Monitoring"}),": Records all incoming and outgoing HTTP request logs for troubleshooting and performance analysis."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"To provide a unified, secure, and manageable facade for all stateless HTTP requests. Separating API management from real-time connection management makes responsibilities more singular and easier to scale and maintain independently."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"2-connection-gateway-service-oceanchat-ws-gateway-stateful",children:["2. ",(0,i.jsx)(s.strong,{children:"Connection Gateway Service (oceanchat-ws-gateway)"})," (Stateful)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"desc",label:"Introduction",default:!0,children:(0,i.jsx)(s.p,{children:"Given that this service is stateful, its design should remain business-agnostic, lightweight, and simple."})}),(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Real-time Connection Entry Point"}),": Serves as the sole entry point for all external WebSocket/TCP long-lived connections."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Connection Authentication"}),': Responsible for authenticating the connection when a client establishes a long-lived connection (by calling the "Auth Service" or using a shared public key for local validation).']}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Data Passthrough"}),": Acts as a pure connection channel, only encapsulating the client's raw data packet (e.g., by attaching ",(0,i.jsx)(s.code,{children:"connectionId"}),", ",(0,i.jsx)(s.code,{children:"gatewayId"}),") and then quickly delivering it to the backend ",(0,i.jsx)(s.strong,{children:"Message Router Service"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Client Message Delivery"}),": Receives instructions from the ",(0,i.jsx)(s.strong,{children:"Real-time Pusher Worker"})," and accurately pushes messages to clients connected to this instance."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"To completely separate the most resource-intensive I/O-bound tasks (maintaining connections) from CPU-bound tasks (business logic). This allows the Connection Gateway to be extremely optimized and scaled horizontally independently to support tens or even hundreds of millions of concurrent connections."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"3-message-router-service-oceanchat-router-stateless",children:["3. ",(0,i.jsx)(s.strong,{children:"Message Router Service (oceanchat-router)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Message Decoding and Dispatching"}),": Receives raw data packets from the ",(0,i.jsx)(s.strong,{children:"Connection Gateway"}),", performs decoding, protocol parsing, and initial validation."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Business Routing"}),": Determines which business microservice should handle the message based on its type, and then dispatches it via the NATS message queue."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Upstream Traffic Control"}),': Implements general rate limiting and circuit breaking. For example, limiting "a maximum of 100 requests per second per user ID". More fine-grained business rate limiting (like group creation frequency) should be implemented in the specific services.']}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Decouples the access layer from the business logic layer. The router service acts as an intermediary coordinator, making the addition, removal, and changes of backend business services completely transparent to the gateway layer, greatly improving system flexibility and maintainability."})})]}),"\n",(0,i.jsx)(s.h2,{id:"layer-2-core-business-logic-layer",children:"Layer 2: Core Business Logic Layer"}),"\n",(0,i.jsx)(s.p,{children:"This layer is responsible for handling all the core business functions of the IM platform, designed as stateless services for easy horizontal scaling."}),"\n",(0,i.jsxs)(s.h3,{id:"4-auth-service-oceanchat-auth-stateless",children:["4. ",(0,i.jsx)(s.strong,{children:"Auth Service (oceanchat-auth)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"User Authentication"}),": Handles user registration, login, logout, and other HTTP requests proxied by the API Gateway."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Token Management"}),": Responsible for generating, validating, and refreshing access tokens (JWT recommended), which is the core of system security."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Provide Validation Capability"}),": Provides internal interfaces for other microservices (especially the ",(0,i.jsx)(s.strong,{children:"Connection Gateway"}),") to validate token effectiveness."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Publish Domain Events"}),": Publishes asynchronous domain events to NATS JetStream upon the completion of critical business operations (e.g., user registration, login), allowing other services to subscribe and react."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Isolates the common and critical security capability of user authentication into a single, trusted service. All other services rely on it to confirm user identity, making responsibilities clear and facilitating unified management of security policies."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"5-user--relationship-service-oceanchat-user-stateless",children:["5. ",(0,i.jsx)(s.strong,{children:"User & Relationship Service (oceanchat-user)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Data Management"}),": Manages user accounts, profiles, friend relationships (add/delete/blacklist), address books, etc."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Authorization Decision-Making"}),': As the sole owner of relationship data, it is responsible for making permission judgments for related operations (e.g., answering "Are user A and B friends?").']}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"User and relationship data are the foundational data of an IM system. An independent service can provide a unified and stable data source for other services. Co-locating the authorization decision logic within this service ensures the consistency of data and rules."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"6-group-service-oceanchat-group-stateless",children:["6. ",(0,i.jsx)(s.strong,{children:"Group Service (oceanchat-group)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Lifecycle Management"}),": Responsible for group creation/dissolution, member management, permission systems, group announcements, group settings, etc."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Authorization Decision-Making"}),": As the sole owner of group data, it contains all group-related authorization logic (e.g., determining if a user is a group member, is muted, etc.)."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"The business logic for group chats (especially permissions and member management) is very complex. Separating it into a service helps reduce code complexity and facilitates independent development and iteration."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"7-message-logic-service-oceanchat-message-stateless",children:["7. ",(0,i.jsx)(s.strong,{children:"Message Logic Service (oceanchat-message)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Permission Check Coordination"}),': Acts as a "coordinator" for permission checks, calling the correct "decision-maker" service to complete the check. For example, it calls the ',(0,i.jsx)(s.strong,{children:"User & Relationship Service"})," for one-on-one messages and the ",(0,i.jsx)(s.strong,{children:"Group Service"})," for group messages."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Message Processing"}),": As the business processing center for one-on-one and group messages, it's responsible for permission checks, content processing (@mentions, sensitive word filtering), generating message IDs, assembling the message body, etc."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Triggering Delivery"}),": After processing is complete, it calls the ",(0,i.jsx)(s.strong,{children:"Push Orchestrator Service"})," to start the message delivery process."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:'Separates the business logic of the message itself ("what it is") from the message delivery process ("how it\'s sent"), making responsibilities clearer.'})})]}),"\n",(0,i.jsx)(s.h2,{id:"layer-3-message-push-pipeline",children:"Layer 3: Message Push Pipeline"}),"\n",(0,i.jsx)(s.p,{children:"This is the key to ensuring reliable, real-time message delivery, and it is a highly asynchronous processing flow."}),"\n",(0,i.jsxs)(s.h3,{id:"8-push-orchestrator-service-oceanchat-orchestrator-stateless",children:["8. ",(0,i.jsx)(s.strong,{children:"Push Orchestrator Service (oceanchat-orchestrator)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Delivery Decision-Making"}),": Receives messages to be delivered from the ",(0,i.jsx)(s.strong,{children:"Message Logic Service"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Status Query"}),": Queries the ",(0,i.jsx)(s.strong,{children:"Presence Service"})," in real-time to get the online status and gateway node of all recipients."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Task Dispatching"}),': Splits the message into "online push tasks" and "offline push tasks" based on the online status, and publishes them to different NATS subjects (using JetStream to ensure persistence).']}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:'As the "brain" of message delivery, it is responsible for complex decision-making logic. Isolating it makes the push flow clearer and easier to monitor and debug.'})})]}),"\n",(0,i.jsxs)(s.h3,{id:"9-real-time-pusher-worker-oceanchat-pusher-realtime-stateless",children:["9. ",(0,i.jsx)(s.strong,{children:"Real-time Pusher Worker (oceanchat-pusher-realtime)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Task Consumption"}),': Listens to the "online push" queue and consumes tasks.']}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Command Issuance"}),": Directly communicates with the ",(0,i.jsx)(s.strong,{children:"Connection Gateway"})," instance where the target user is located, instructing it to deliver the message."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Tech Stack"}),": NATS JetStream subscriber, ioredis (for inter-gateway Pub/Sub)."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Dedicated to handling online message pushing, it can be scaled independently based on the number of online users and message volume to ensure real-time performance."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"10-offline-pusher-worker-oceanchat-pusher-offline-stateless",children:["10. ",(0,i.jsx)(s.strong,{children:"Offline Pusher Worker (oceanchat-pusher-offline)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Task Consumption"}),': Subscribes to the "offline push" topic and consumes tasks.']}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"API Calling"}),": Calls the push APIs of Apple APNS, Google FCM, or domestic vendors to send offline notifications."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Integration with third-party APIs comes with network latency and uncertainty. Isolating it prevents its failures or slowness from affecting the core real-time push link."})})]}),"\n",(0,i.jsx)(s.h2,{id:"layer-4-foundational-support-services",children:"Layer 4: Foundational Support Services"}),"\n",(0,i.jsx)(s.p,{children:"These services provide stable and efficient foundational capabilities for the entire platform."}),"\n",(0,i.jsxs)(s.h3,{id:"11-presence-service-oceanchat-presence-stateless",children:["11. ",(0,i.jsx)(s.strong,{children:"Presence Service (oceanchat-presence)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Status Maintenance"}),": Maintains the global online status of users in real-time through a ",(0,i.jsx)(s.code,{children:"userId -> {gatewayId, status}"})," mapping."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Status Query"}),": Provides millisecond-level online status query interfaces for services like the ",(0,i.jsx)(s.strong,{children:"Push Orchestrator Service"}),"."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Online presence is the cornerstone of a distributed IM system, with extremely frequent reads and writes. An independent service, highly optimized with an in-memory database like Redis, ensures high performance."})})]}),"\n",(0,i.jsxs)(s.h3,{id:"12-query-service-oceanchat-query-stateless",children:["12. ",(0,i.jsx)(s.strong,{children:"Query Service (oceanchat-query)"})," (Stateless)"]}),"\n",(0,i.jsxs)(k,{children:[(0,i.jsx)(P,{value:"resp",label:"Core Responsibilities",default:!0,children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Unified Query Entry Point"}),": Provides a unified HTTP API for clients to query data such as message history and session lists."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Tiered Query"}),": Intelligently fetches and aggregates data from different storage media (Redis cache, MongoDB, etc.) based on the query's time range."]}),"\n"]})}),(0,i.jsx)(P,{value:"reason",label:"Reason for Separation",children:(0,i.jsx)(s.p,{children:"Implements read-write splitting. Separating high-frequency read operations from the core write path allows for independent optimization of query performance without affecting the stability of message writing."})})]}),"\n",(0,i.jsx)(s.h3,{id:"data-processing-pipeline-messagepersistence-message-persistence",children:"Data Processing Pipeline (MessagePersistence): Message Persistence"}),"\n",(0,i.jsx)(s.admonition,{title:"This is an asynchronous process, not an independent service",type:"note",children:(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Core Responsibility"}),": After the ",(0,i.jsx)(s.strong,{children:"Message Logic Service"})," processes a message, besides calling the push service, it also sends a copy of the message to a dedicated NATS topic for persistence (backed by JetStream). One or more independent ",(0,i.jsx)(s.strong,{children:"subscriber processes (Writers)"})," will listen to this queue and batch-write the messages to the database."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Reason for Separation"}),': Complete asynchronicity. The sending and receiving of messages should not wait for the database write to complete. This "write-after-persistence" design maximizes the real-time nature of messages.']}),"\n"]}),"\n"]})}),"\n",(0,i.jsx)(s.h2,{id:"process-description",children:"Process Description"}),"\n",(0,i.jsx)(s.h3,{id:"login-phase",children:"Login Phase"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:["Client A \u2192 ",(0,i.jsx)(s.strong,{children:"API Gateway"})," (sends username/password to ",(0,i.jsx)(s.code,{children:"/auth/login"}),")."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"API Gateway"})," \u2192 ",(0,i.jsx)(s.strong,{children:"Auth Service"})," (forwards login request)."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"Auth Service"})," validates successfully, generates a JWT, and returns it to the ",(0,i.jsx)(s.strong,{children:"API Gateway"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["3a. ",(0,i.jsx)(s.strong,{children:"Authentication Service"})," (async) \u2192 NATS JetStream (Publishes ",(0,i.jsx)(s.code,{children:"auth.event.user.loggedIn"})," event)."]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.strong,{children:"API Gateway"})," \u2192 Client A (responds with the JWT to the client)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(s.h3,{id:"message-sending-phase",children:"Message Sending Phase"}),"\n",(0,i.jsxs)(s.ol,{start:"5",children:["\n",(0,i.jsx)(s.li,{children:"User A sends a message to group G."}),"\n",(0,i.jsxs)(s.li,{children:["Client A \u2192 ",(0,i.jsx)(s.strong,{children:"Connection Gateway-1"})," (establishes a connection, attaching the JWT)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Connection Gateway-1"})," validates the JWT's legitimacy (by calling the ",(0,i.jsx)(s.strong,{children:"Auth Service"}),"), confirms the user identity as A, and attaches ",(0,i.jsx)(s.code,{children:"userId: A"})," to subsequent messages."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Connection Gateway-1"})," \u2192 ",(0,i.jsx)(s.strong,{children:"Message Router Service"})," (passthrough)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Message Router Service"})," \u2192 ",(0,i.jsx)(s.strong,{children:"Message Logic Service"})," (routing)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Message Logic Service"})," processes the message (checks permissions, generates ID), then splits into two paths:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["\u2192 ",(0,i.jsx)(s.strong,{children:"Push Orchestrator Service"})," (initiates delivery)"]}),"\n",(0,i.jsx)(s.li,{children:"\u2192 NATS persistence topic (prepares for storage)"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Push Orchestrator Service"})," queries the ",(0,i.jsx)(s.strong,{children:"Presence Service"})," and learns that group member B is online (on gateway 2), and C is offline."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Push Orchestrator Service"})," \u2192 NATS online push topic (task for B) and NATS offline push topic (task for C)."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Real-time Pusher Worker"})," consumes B's task \u2192 instructs ",(0,i.jsx)(s.strong,{children:"Connection Gateway-2"})," \u2192 Client B receives the message."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Offline Pusher Worker"})," consumes C's task \u2192 calls APNS/FCM API \u2192 Client C receives a notification."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.strong,{children:"Persistence Writer"})," subscribes to and consumes the NATS message \u2192 writes to MongoDB."]}),"\n"]})]})}function q(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(M,{...e})}):M(e)}},8453:(e,s,n)=>{n.d(s,{R:()=>a,x:()=>o});var r=n(6540);const i={},t=r.createContext(i);function a(e){const s=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:s},e.children)}}}]);