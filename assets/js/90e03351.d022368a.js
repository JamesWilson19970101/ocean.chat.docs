"use strict";(self.webpackChunkoceanchat_devdocs=self.webpackChunkoceanchat_devdocs||[]).push([[4119],{8453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>o});var t=s(6540);const i={},r=t.createContext(i);function a(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(r.Provider,{value:n},e.children)}},9787:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"devdocs/distributed","title":"Distributed System Related Issues","description":"Distributed Transactions","source":"@site/docs/devdocs/distributed.md","sourceDirName":"devdocs","slug":"/devdocs/distributed","permalink":"/ocean.chat.docs/docs/devdocs/distributed","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"concurrency considerations","permalink":"/ocean.chat.docs/docs/devdocs/concurrency considerations"},"next":{"title":"graphql vs http in oceanchat","permalink":"/ocean.chat.docs/docs/devdocs/graphql vs http in oceanchat"}}');var i=s(4848),r=s(8453);const a={},o="Distributed System Related Issues",l={},d=[{value:"Distributed Transactions",id:"distributed-transactions",level:2},{value:"Places Where Distributed Transactions Should Absolutely Not Be Used: Core Chat",id:"places-where-distributed-transactions-should-absolutely-not-be-used-core-chat",level:3},{value:"Must-use or highly probable application: Value-added services",id:"must-use-or-highly-probable-application-value-added-services",level:3}];function c(e){const n={h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"distributed-system-related-issues",children:"Distributed System Related Issues"})}),"\n",(0,i.jsx)(n.h2,{id:"distributed-transactions",children:"Distributed Transactions"}),"\n",(0,i.jsx)(n.p,{children:'Distributed transactions are almost never needed for the core "chat" function; however, they might be required for a complete "IM platform."'}),"\n",(0,i.jsx)(n.p,{children:"Ocean Chat needs to be viewed in two separate worlds:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"One is the information flow (messages)."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"The other is the flow of funds/status (value)."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"places-where-distributed-transactions-should-absolutely-not-be-used-core-chat",children:"Places Where Distributed Transactions Should Absolutely Not Be Used: Core Chat"}),"\n",(0,i.jsx)(n.p,{children:'Any code that affects the user\'s "message sending speed" and "message receiving success rate" will not use strongly consistent distributed transactions (such as TCC/Seata-AT).'}),"\n",(0,i.jsx)(n.p,{children:"Why?"}),"\n",(0,i.jsx)(n.p,{children:"Different concurrency levels: WeChat sends millions of messages per second, but only a few thousand red envelopes per second. Distributed transactions (Saga/TCC) involve multiple database operations and locks, resulting in significant performance overhead, and simply cannot handle the high concurrency of message flows."}),"\n",(0,i.jsx)(n.p,{children:"Different tolerance levels: A 1-second delay in message arrival (eventual consistency) might be imperceptible to users; however, if ensuring consistency causes a 1-second delay in message sending, users will immediately uninstall the app."}),"\n",(0,i.jsx)(n.p,{children:'This platform plans to use an eventual consistency solution of "local transactions + NATS retries".'}),"\n",(0,i.jsx)(n.h3,{id:"must-use-or-highly-probable-application-value-added-services",children:"Must-use or highly probable application: Value-added services"}),"\n",(0,i.jsx)(n.p,{children:"A mature IM platform is not limited to text messaging. When developing the following functions, distributed transactions (Saga or TCC) must be used:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Wallet and Red Packet System (Fund Flow)"}),"\n",(0,i.jsx)(n.p,{children:"This is the most typical distributed transaction scenario in IM."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Scenario: User A sends a 100 RMB red packet."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Problem: If the wallet deducts the money, the red packet generation fails; or the red packet is generated, but the wallet doesn't deduct the money."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'Solution: "Retry" cannot be used here. Financial matters must be handled rigorously.'}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"TCC (Try-Confirm-Cancel) mode is required."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Try: Freeze 100 yuan in user A's account."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Confirm: Deduct the payment and generate a red envelope."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Cancel: If red envelope generation fails, unfreeze the 100 yuan."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Paid Group Entry (Benefit Exchange)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Scenario: A user pays 50 yuan to join a high-end technical group."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Logic: Only successful payment allows entry into the group; if entry fails (e.g., the group is full), an automatic refund must be issued."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Solution: This is a standard Saga scenario."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Positive Process: Deduction -> Group Entry."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Compensation: Group Entry Failure -> Refund Logic Triggered."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Cross-Tenant/Cross-Shard Group Operations (Data Migration)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Scenario: IM becomes large, MongoDB implements sharding, or a SaaS version of IM is implemented."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Logic: Migrate a very large group from shard A to shard B to balance the load."}),"\n"]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);