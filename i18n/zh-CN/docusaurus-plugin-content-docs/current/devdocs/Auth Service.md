# 认证服务

## User Module

管理用户这个“资源”。

- 它关心的是用户的生命周期：创建（Create）、读取（Read）、更新（Update）、删除（Delete），也就是我们常说的 CRUD 操作。
- 注册，本质上就是创建一个新用户。所以 POST /users 这个 API 非常符合 RESTful 风格，语义上就是“创建一个用户资源”。
- 这个模块应该能回答：“系统中有哪些用户？”、“某个用户的个人资料是什么？”、“如何创建一个新用户？”

### 用户注册

创建新用户。支持多种注册方式，如邮箱+密码、手机号+短信验证码、用户名+密码、谷歌账号注册等。注册过程中对于需要输入密码进行注册的方式，会进行限制（如密码强度、邮箱/手机格式是否合法等）。

注册成功后需要在数据库中创建记录，返回令牌，使用户自动登录系统。

:::info
注册并登录之后，让用户直接进入聊天室，头像和名称使用友好的默认值；
用户第一次进入主界面时，在顶部出现一个可以轻松关闭的提示条，例如：“欢迎来到 OceanChat！设置一个头像和昵称，能让朋友们更快认出你哦 [去设置]”。
在“我的”或“设置”图标上显示一个小红点，吸引用户去点击。
当用户尝试进行某个关键操作时（比如第一次发消息、第一次加好友），可以弹出一个小卡片提示：“设置一个头像，让你的发言更有辨识度吧！”
:::

## Ocean Chat Auth Module

验证用户的身份并管理会话。

- 它关心的是“你是谁？”以及“如何证明你是你？”。
- 登录，本质上是创建一个新的“会话”（Session）或颁发一个“通行证”（JWT）。它并不创建或修改用户本身，而是验证用户提供的凭证是否正确。
- 这个模块应该能回答：“这个用户名和密码是否匹配？”、“如何颁发一个令牌（Token）？”、“这个令牌是否有效？”、“如何让一个令牌失效（登出）？”

### 登录

1. 通过 NATS 监听 auth.login 主题。
2. 接收来自 API 网关转发的登录凭证（用户名和密码）。
3. 身份验证: 从数据库中查找用户，并比对哈希后的密码是否匹配。
4. 令牌生成: 如果身份验证成功，使用 @nestjs/jwt 生成一个包含用户 ID（sub）和用户名的 JWT。
5. 响应: 返回一个包含 accessToken 和用户基本信息的对象。如果凭证无效，则返回错误。

### 令牌验证

1. 通过 NATS 监听 auth.token.validate 主题（如测试代码 auth.service.spec.ts 中的 validateToken 方法所示）。
2. 接收其他服务（ API 网关的 JwtAuthGuard）发来的 JWT。
3. 令牌校验: 使用 JwtService 验证令牌的签名和时效性。
4. 响应: 如果令牌有效，返回解码后的用户信息（payload）；如果无效，则返回 null 或抛出异常，表明认证失败。
