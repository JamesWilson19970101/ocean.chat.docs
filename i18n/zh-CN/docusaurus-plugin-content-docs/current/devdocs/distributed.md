# 分布式相关问题

## 分布式事务

对于“聊天”这个核心功能，几乎用不到分布式事务；但对于一个完整的“IM 平台”，有可能会用到。

需要把Ocean Chat拆分成两个世界来看：

- 一个是信息流（消息）。
- 一个是资金流/状态流（价值）。

### 绝对不应该用分布式事务的地方：核心聊天链路

任何影响用户“发消息速度”和“收消息成功率”的环节，都不会上强一致性的分布式事务（如 TCC/Seata-AT）。

为什么？

并发量级不同： 微信每秒钟发出的消息是百万级的，但每秒钟发的红包可能只有几千个。分布式事务（Saga/TCC）因为涉及多次数据库操作和锁，性能损耗极大，根本扛不住消息流的高并发。

容忍度不同： 消息晚到 1 秒钟（最终一致性），用户可能感觉不到；但如果为了保证一致性导致发消息卡顿 1 秒，用户会直接卸载。

本平台计划使用 “本地事务 + NATS 重试” 的最终一致性方案。

### 必须或者极大概率要用的地方：增值业务

一个成熟的 IM 平台不仅仅是发文字，当开始开发以下功能时，分布式事务（Saga 或 TCC）就必须使用了：

1. 钱包与红包系统（资金流）

    这是 IM 中最典型的分布式事务场景。

    - 场景： 用户 A 发一个 100 元的红包。